"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=handler;var _db=require("../utils/db"),_mongoose=_interopRequireDefault(require("mongoose")),_ably=require("../utils/ably");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var postSchema=new _mongoose.default.Schema({message:String,timestamp:Date,username:String,sessionId:String,likes:{type:Number,default:0},dislikes:{type:Number,default:0},likedBy:[String],dislikedBy:[String],comments:[{username:String,comment:String,timestamp:Date}]}),Post=_mongoose.default.model("Post",postSchema),setCorsHeaders=function(e){e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, PUT, PATCH, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type")};function handler(s,t){var r,a,n,o,i,u,l,c,m,d,p,g,b,k;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if("OPTIONS"===s.method)return setCorsHeaders(t),e.abrupt("return",t.status(200).end());e.next=3;break;case 3:if(setCorsHeaders(t),"POST"!==s.method){e.next=38;break}if(r=s.body,a=r.message,n=r.username,o=r.sessionId,a&&""!==a.trim()){e.next=8;break}return e.abrupt("return",t.status(400).json({message:"Message cannot be empty"}));case 8:if(n&&o){e.next=10;break}return e.abrupt("return",t.status(400).json({message:"Username and sessionId are required"}));case 10:return e.prev=10,console.log("Connecting to database..."),e.next=14,regeneratorRuntime.awrap((0,_db.connectToDatabase)());case 14:return console.log("Database connected successfully."),i=new Post({message:a,timestamp:new Date,username:n,sessionId:o}),e.next=18,regeneratorRuntime.awrap(i.save());case 18:return console.log("New post saved:",i),e.prev=19,e.next=22,regeneratorRuntime.awrap((0,_ably.publishToAbly)("newOpinion",i));case 22:console.log("Post published to Ably:",i),e.next=28;break;case 25:e.prev=25,e.t0=e.catch(19),console.error("Error publishing to Ably:",e.t0);case 28:u={_id:i._id,message:i.message,timestamp:i.timestamp,username:i.username,likes:i.likes,dislikes:i.dislikes,comments:i.comments},t.status(201).json(u),e.next=36;break;case 32:e.prev=32,e.t1=e.catch(10),console.error("Error saving post:",e.t1),t.status(500).json({message:"Error saving post",error:e.t1});case 36:e.next=79;break;case 38:if("PUT"!==s.method&&"PATCH"!==s.method){e.next=78;break}if(l=s.body,c=l.postId,m=l.message,d=l.likes,p=l.dislikes,g=l.comments,c){e.next=42;break}return e.abrupt("return",t.status(400).json({message:"Post ID is required"}));case 42:return e.prev=42,console.log("Connecting to database..."),e.next=46,regeneratorRuntime.awrap((0,_db.connectToDatabase)());case 46:return console.log("Database connected successfully."),e.next=49,regeneratorRuntime.awrap(Post.findById(c));case 49:if(b=e.sent){e.next=52;break}return e.abrupt("return",t.status(404).json({message:"Post not found"}));case 52:return m&&""!==m.trim()&&(b.message=m),void 0!==d&&(b.likes=d),void 0!==p&&(b.dislikes=p),void 0!==g&&(b.comments=g),e.next=58,regeneratorRuntime.awrap(b.save());case 58:return console.log("Post updated:",b),e.prev=59,e.next=62,regeneratorRuntime.awrap((0,_ably.publishToAbly)("editOpinion",b));case 62:console.log("Post updated in Ably:",b),e.next=68;break;case 65:e.prev=65,e.t2=e.catch(59),console.error("Error publishing to Ably:",e.t2);case 68:k={_id:b._id,message:b.message,timestamp:b.timestamp,username:b.username,likes:b.likes,dislikes:b.dislikes,comments:b.comments},t.status(200).json(k),e.next=76;break;case 72:e.prev=72,e.t3=e.catch(42),console.error("Error editing post:",e.t3),t.status(500).json({message:"Error editing post",error:e.t3});case 76:e.next=79;break;case 78:t.status(405).json({message:"Method Not Allowed"});case 79:case"end":return e.stop()}},null,null,[[10,32],[19,25],[42,72],[59,65]])}
//# sourceMappingURL=postOpinion.min.js.map
